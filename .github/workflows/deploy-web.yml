name: Debug Flutter Web Build

on:
  push:
    tags: ['v*']

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
      
      - name: Debug Information
        run: |
          echo "=== Debug Information ==="
          echo "Current Flutter version:"
          flutter --version
          
          echo ""
          echo "Available devices:"
          flutter devices
          
          echo ""
          echo "Check web support:"
          flutter config
          
          echo ""
          echo "Directory structure:"
          find . -maxdepth 3 -type d | sort
          
          echo ""
          echo "Check if example directory exists:"
          if [ -d "example" ]; then
            echo "example directory found"
            echo "Contents of example:"
            ls -la example/
            
            if [ -f "example/pubspec.yaml" ]; then
              echo "example/pubspec.yaml exists"
              echo "App name:"
              grep '^name:' example/pubspec.yaml
            fi
          else
            echo "ERROR: example directory not found"
          fi
          
          echo ""
          echo "Flutter build web help:"
          flutter build web --help || echo "Failed to get help"
      
      - name: Try Build
        if: success()
        run: |
          cd example
          
          echo "Testing build command..."
          
          # 测试各种构建命令
          echo "1. Testing basic build:"
          flutter build web --release --dry-run && echo "Basic build works" || echo "Basic build failed"
          
          echo ""
          echo "2. Testing with base-href:"
          flutter build web --release --base-href / --dry-run && echo "With base-href works" || echo "With base-href failed"
          
          echo ""
          echo "3. Testing with dart-define:"
          flutter build web --release --dart-define=TEST=1 --dry-run && echo "With dart-define works" || echo "With dart-define failed"
          
          echo ""
          echo "4. Full build test:"
          flutter build web --release
          
          echo ""
          echo "Build result:"
          if [ -d "build/web" ]; then
            echo "SUCCESS: Build directory created"
            ls -la build/web/
          else
            echo "FAILED: Build directory not created"
          fi
      
      - name: Deploy if Successful
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./example/build/web
          publish_branch: gh-pages
          commit_message: "Deploy from debug build"